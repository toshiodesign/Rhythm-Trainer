<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PolyArchetype">
    <meta name="format-detection" content="telephone=no">

    <title>Rhythm Archetype (Neural Style)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');

        :root {
            /* Neural DSP 風格色票 */
            --bg-color: #0b0b0d;         /* 近乎全黑的背景 */
            --panel-bg: #141416;         /* 機櫃面板色 */
            --border-color: #333333;     /* 暗淡的邊框線 */
            --line-active: #ffffff;      /* 啟動時的亮白線條 */
            --accent-glow: rgba(255, 255, 255, 0.4); /* 白光暈 */
            --accent-secondary: #00e0ff; /* 數位感的青色 (選用) */
            
            --text-main: #e5e5e5;        /* 亮灰白文字 */
            --text-muted: #666666;       /* 暗灰文字 */
            
            --fader-track: #2a2a2a;
            --knob-color: #d1d5db;
        }

        body {
            font-family: 'Inter', sans-serif; /* 乾淨的現代無襯線體 */
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; 
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            
            /* iPad 優化 */
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 主控制面板 (模擬 Rack 機櫃) --- */
        .controls-wrapper {
            background: var(--panel-bg);
            /* 模擬金屬髮絲紋質感 */
            background-image: linear-gradient(to bottom, #1a1a1c, #141416);
            padding: 20px 40px;
            border: 1px solid var(--border-color);
            border-top: 1px solid #444; /* 頂部高光 */
            border-radius: 4px; /* 極小的圓角，接近直角 */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            
            width: 100%;
            max-width: 900px;
            margin-bottom: 40px;
            
            display: flex;
            flex-wrap: wrap;
            gap: 40px; /* 增加間距，像硬體面板 */
            align-items: flex-end; /* 讓標籤對齊上方 */
            justify-content: space-around;
            position: relative;
        }

        /* 裝飾螺絲釘 (模擬硬體) */
        .controls-wrapper::before, .controls-wrapper::after {
            content: '+';
            position: absolute;
            color: #333;
            font-family: monospace;
            font-size: 20px;
            top: 10px;
        }
        .controls-wrapper::before { left: 15px; }
        .controls-wrapper::after { right: 15px; }

        .control-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 12px; 
            position: relative;
        }
        
        /* 垂直分隔線 */
        .control-group:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -20px;
            top: 10%;
            height: 80%;
            width: 1px;
            background: linear-gradient(to bottom, transparent, #333, transparent);
        }

        .control-label { 
            font-size: 0.7rem; 
            font-weight: 600; 
            color: var(--text-muted); 
            text-transform: uppercase; 
            letter-spacing: 2px; /* 寬字距 */
            margin-bottom: 5px;
        }

        /* --- 替換 Select 樣式 --- */
        select { 
            appearance: none;
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 30px 8px 15px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            border-radius: 2px;
            cursor: pointer;
            text-align: center;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 10px auto;
        }
        select:focus { outline: none; border-color: var(--text-muted); }

        /* --- 線條化 Slider (Fader Style) --- */
        input[type="range"] { 
            -webkit-appearance: none;
            width: 120px; 
            background: transparent;
            height: 20px; /* 增加觸控高度 */
        }
        
        /* 軌道 Track */
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            background: var(--fader-track);
            border-radius: 0;
        }
        
        /* 推桿 Thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 6px;
            border-radius: 1px;
            background: var(--text-main);
            margin-top: -7px; /* 置中 */
            box-shadow: 0 0 5px rgba(255,255,255,0.3);
            border: none;
            cursor: pointer;
        }

        .val-display { 
            font-family: 'Courier New', monospace; 
            font-size: 0.8rem;
            color: var(--line-active);
            text-shadow: 0 0 5px var(--accent-glow);
        }

        /* --- 顯示區域 (Screen) --- */
        .rhythm-stage {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;
            width: 100%; max-width: 1000px; min-height: 180px; 
            margin-bottom: 40px; padding: 30px;
            
            /* 螢幕感 */
            background: #080808;
            border: 1px solid #222;
            border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
        }

        .beat-card {
            background-color: transparent; 
            /* 線框風格 */
            border: 1px solid #333; 
            border-radius: 4px;
            width: 140px; height: 140px;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.1s ease;
            position: relative;
        }
        
        /* 播放時的高亮：白色發光線條 */
        .beat-card.active {
            border-color: var(--line-active);
            box-shadow: 0 0 15px var(--accent-glow), inset 0 0 10px rgba(255,255,255,0.1);
            background-color: rgba(255,255,255,0.02);
            transform: scale(1.02);
        }
        
        /* 隨機變換時的動畫 */
        .beat-card.changing {
            animation: glitch 0.2s linear;
        }
        @keyframes glitch {
            0% { border-color: #333; opacity: 0.5; }
            50% { border-color: var(--accent-secondary); opacity: 1; }
            100% { border-color: #333; opacity: 1; }
        }
        
        /* SVG 線條優化 */
        .beat-card .svg-container { width: 70%; height: 70%; opacity: 0.4; transition: opacity 0.1s; }
        .beat-card.active .svg-container { opacity: 1; filter: drop-shadow(0 0 5px rgba(255,255,255,0.6)); }
        .beat-card svg { width: 100%; height: 100%; fill: var(--text-main); }


        /* --- 底部踏板區 (Footswitches) --- */
        .playback-bar { 
            display: flex; align-items: center; gap: 30px; margin-bottom: 40px; 
            background: #111;
            padding: 15px 30px;
            border-radius: 4px;
            border: 1px solid #222;
        }
        
        /* 線條化的圓形按鈕 */
        .btn-circle {
            width: 70px; height: 70px; 
            border-radius: 50%; 
            background: transparent;
            border: 2px solid var(--text-muted);
            color: var(--text-muted);
            font-size: 1.5rem; 
            cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            transition: all 0.2s;
        }
        .btn-circle:hover { border-color: var(--text-main); color: var(--text-main); }
        
        .btn-circle.playing { 
            border-color: var(--line-active);
            color: var(--line-active);
            box-shadow: 0 0 20px var(--accent-glow), inset 0 0 10px var(--accent-glow);
            text-shadow: 0 0 10px white;
        }

        /* 方形開關按鈕 */
        .btn-pill {
            padding: 10px 24px;
            border-radius: 2px; /* 方角 */
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .btn-pill:hover { border-color: #666; color: var(--text-main); }
        
        /* 啟用狀態 - 底部亮條 */
        .btn-pill.active { 
            color: var(--line-active);
            border-color: var(--line-active);
            background: rgba(255,255,255,0.05);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }
        .btn-pill.active::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 2px;
            background: var(--line-active);
            box-shadow: 0 0 10px white;
        }

        /* --- Preset Library (Presets) --- */
        .library-panel { 
            background: var(--panel-bg); 
            width: 100%; max-width: 900px; 
            border-radius: 4px; 
            padding: 2px; /* 極細邊框感 */
            border: 1px solid var(--border-color); 
        }
        
        .library-inner {
            background: var(--bg-color);
            padding: 20px;
            border-radius: 2px;
        }

        .library-header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; padding-bottom: 10px; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .library-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }
        
        .pattern-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px; 
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 2000px;
            opacity: 1;
            overflow-y: auto;
        }
        .pattern-grid.collapsed { max-height: 0; opacity: 0; margin: 0; }

        .pattern-item {
            aspect-ratio: 1; 
            border: 1px solid #222; 
            background: #0f0f0f;
            border-radius: 2px;
            cursor: pointer; display: flex; justify-content: center; align-items: center; padding: 10px; 
            transition: 0.2s;
            opacity: 0.5;
        }
        .pattern-item:hover { border-color: #555; opacity: 0.8; }
        .pattern-item.selected { 
            border-color: var(--line-active); 
            opacity: 1;
            background: rgba(255,255,255,0.02);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
        }
        .pattern-item svg { width: 100%; height: 100%; pointer-events: none; fill: var(--text-main); }

        .btn-sm { 
            padding: 5px 10px; font-size: 0.7rem; border-radius: 2px; 
            border: 1px solid var(--border-color); 
            background: transparent; 
            color: var(--text-muted);
            text-transform: uppercase;
            cursor: pointer; 
        }
        .btn-sm:hover { border-color: var(--text-main); color: var(--text-main); }

        /* 全局移除 focus outline，改用自定義樣式 */
        *:focus { outline: none; }
        
        /* Icon 微調 */
        .icon-text { font-size: 1.2rem; line-height: 1; margin-right: 5px; }

    </style>
</head>
<body>

    <div class="controls-wrapper">
        <div class="control-group">
            <span class="control-label">Meter</span>
            <select id="timeSigSelect">
                <option value="4/4" selected>4/4 SIMPLE</option>
                <option value="2/4">2/4 SIMPLE</option>
                <option value="3/4">3/4 SIMPLE</option>
                <option value="5/4">5/4 SIMPLE</option>
                <option disabled>──────────</option>
                <option value="6/8">6/8 COMPOUND</option>
                <option value="9/8">9/8 COMPOUND</option>
                <option value="12/8">12/8 COMPOUND</option>
            </select>
        </div>
        
        <div class="control-group">
            <span class="control-label">Tempo</span>
            <span id="bpmDisplay" class="val-display">100</span>
            <input type="range" id="bpmSlider" min="40" max="200" value="100">
        </div>
        
        <div class="control-group">
            <span class="control-label">Kick</span>
            <input type="range" id="kickVolSlider" min="0" max="100" value="80">
        </div>
        
        <div class="control-group">
            <span class="control-label">Clap</span>
            <input type="range" id="clapVolSlider" min="0" max="100" value="80">
        </div>

        <div class="control-group">
            <span class="control-label">Chaos</span>
            <span id="shuffleDisplay" class="val-display">0%</span>
            <input type="range" id="shuffleSlider" min="0" max="100" value="0">
        </div>
    </div>

    <div class="rhythm-stage" id="displayArea"></div>

    <div class="playback-bar">
        <button class="btn-pill" onclick="generateRhythm()">
            <span class="icon-text">⟳</span> Randomize
        </button>
        
        <button class="btn-circle" id="playBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        </button>
        
        <button class="btn-pill active" id="kickBtn">
            <span class="icon-text">●</span> Kick
        </button>
    </div>

    <div class="library-panel">
        <div class="library-inner">
            <div class="library-header">
                <div style="display:flex; align-items:center; gap:15px;">
                    <button class="btn-sm" onclick="toggleLibrary()" id="toggleLibBtn">▼</button>
                    <span class="library-title" id="libTitle">Pattern Library</span>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-sm" onclick="selectAllPatterns()">ALL</button>
                    <button class="btn-sm" onclick="deselectAllPatterns()">NONE</button>
                </div>
            </div>
            <div class="pattern-grid" id="libraryGrid">
                </div>
        </div>
    </div>

    <script>
        window.ALL_PATTERNS = [];
    </script>

    <script src="rhythm_data_1.js"></script>
    <script src="rhythm_data_2.js"></script>
    <script src="rhythm_data_3.js"></script>
    <script src="rhythm_data_4.js"></script>
    <script src="rhythm_data_5.js"></script>
    <script src="rhythm_data_6.js"></script>
    <script src="rhythm_data_7.js"></script>
    <script src="rhythm_data_8.js"></script>

    <script>
        // --- 邏輯部分保持不變，與 V9 完全相同 ---
        let audioCtx;
        let isPlaying = false;
        let bpm = 100;
        let kickVolume = 0.8;
        let clapVolume = 0.8;
        let shuffleProb = 0;
        let kickEnabled = true;

        let timerID;
        let nextBeatTime = 0;
        let currentBeatIndex = 0;
        let beatsPerBar = 4;
        let currentMode = 'simple';
        let activePatternIDs = [];
        let currentMeasure = [];

        // UI Refs
        const displayArea = document.getElementById('displayArea');
        const libraryGrid = document.getElementById('libraryGrid');
        const libTitle = document.getElementById('libTitle');
        const playBtn = document.getElementById('playBtn');

        window.addEventListener('load', () => {
            if (!window.ALL_PATTERNS || window.ALL_PATTERNS.length === 0) {
                libraryGrid.innerHTML = "<div style='color:#666; padding:20px; font-family:monospace;'>ERROR: rhythm_data.js not loaded.</div>";
                return;
            }
            window.ALL_PATTERNS.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true, sensitivity: 'base'}));
            updateTimeSignature();
            generateRhythm();
        });

        function toggleLibrary() {
            const grid = document.getElementById('libraryGrid');
            const btn = document.getElementById('toggleLibBtn');
            grid.classList.toggle('collapsed');
            btn.innerText = grid.classList.contains('collapsed') ? '▶' : '▼';
        }

        function deselectAllPatterns() {
            const items = document.querySelectorAll('.pattern-item');
            activePatternIDs = [];
            items.forEach(el => el.classList.remove('selected'));
        }

        function selectAllPatterns() {
            const items = document.querySelectorAll('.pattern-item');
            const patternsToShow = window.ALL_PATTERNS.filter(p => p.type === currentMode);
            activePatternIDs = patternsToShow.map(p => p.id);
            items.forEach(el => el.classList.add('selected'));
        }

        function updateTimeSignature() {
            const val = document.getElementById('timeSigSelect').value;
            const [num, den] = val.split('/').map(Number);
            if (den === 8 && num % 3 === 0) {
                currentMode = 'compound';
                beatsPerBar = num / 3;
                libTitle.innerText = `COMPOUND METER (${val})`;
            } else {
                currentMode = 'simple';
                beatsPerBar = num;
                libTitle.innerText = `SIMPLE METER (${val})`;
            }
            renderLibrary();
        }

        function renderLibrary() {
            libraryGrid.innerHTML = '';
            const patternsToShow = window.ALL_PATTERNS.filter(p => p.type === currentMode);
            activePatternIDs = patternsToShow.map(p => p.id); 

            if (patternsToShow.length === 0) {
                libraryGrid.innerHTML = "<div style='color:#444'>NO DATA</div>";
                return;
            }

            patternsToShow.forEach(p => {
                const div = document.createElement('div');
                div.className = 'pattern-item selected';
                div.innerHTML = p.svg; 
                div.title = p.name;
                div.onclick = () => {
                    div.classList.toggle('selected');
                    if (activePatternIDs.includes(p.id)) {
                        activePatternIDs = activePatternIDs.filter(id => id !== p.id);
                    } else {
                        activePatternIDs.push(p.id);
                    }
                };
                libraryGrid.appendChild(div);
            });
        }

        function generateRhythm() {
            if (activePatternIDs.length === 0) return;
            currentMeasure = [];
            displayArea.innerHTML = '';
            for (let i = 0; i < beatsPerBar; i++) {
                const randId = activePatternIDs[Math.floor(Math.random() * activePatternIDs.length)];
                const patternObj = window.ALL_PATTERNS.find(p => p.id === randId);
                if (patternObj) {
                    currentMeasure.push(patternObj);
                    const card = document.createElement('div');
                    card.className = 'beat-card';
                    card.innerHTML = `<div class="svg-container">${patternObj.svg}</div>`;
                    displayArea.appendChild(card);
                }
            }
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playSound(time, type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            if (type === 'kick') {
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                gain.gain.setValueAtTime(kickVolume, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
                osc.start(time);
                osc.stop(time + 0.5);
            } else {
                // Clap Sound
                const bufferSize = audioCtx.sampleRate * 2; 
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }
                
                const noise = audioCtx.createBufferSource();
                noise.buffer = buffer;
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 1200; 
                filter.Q.value = 1; 
                const clapGain = audioCtx.createGain();
                clapGain.gain.setValueAtTime(clapVolume, time); 
                clapGain.gain.exponentialRampToValueAtTime(0.01, time + 0.15); 
                noise.connect(filter);
                filter.connect(clapGain);
                clapGain.connect(audioCtx.destination);
                noise.start(time);
                noise.stop(time + 0.2);
            }
        }

        function scheduler() {
            while (nextBeatTime < audioCtx.currentTime + 0.1) {
                const beatDuration = 60.0 / bpm;
                const currentIdx = currentBeatIndex;
                const visualDelay = (nextBeatTime - audioCtx.currentTime) * 1000;
                
                setTimeout(() => {
                    const cards = document.querySelectorAll('.beat-card');
                    cards.forEach((c, i) => {
                        if (i === currentIdx) c.classList.add('active');
                        else c.classList.remove('active');
                    });
                }, Math.max(0, visualDelay));

                if (kickEnabled) playSound(nextBeatTime, 'kick');

                const pattern = currentMeasure[currentBeatIndex];
                if (pattern && pattern.events) {
                    pattern.events.forEach(ratio => {
                        playSound(nextBeatTime + (ratio * beatDuration), 'clap');
                    });
                }

                nextBeatTime += beatDuration;
                currentBeatIndex++;

                if (currentBeatIndex >= beatsPerBar) {
                    currentBeatIndex = 0;
                    if (shuffleProb > 0 && activePatternIDs.length > 0) {
                        setTimeout(() => {
                            for (let i = 0; i < beatsPerBar; i++) {
                                if (Math.random() * 100 < shuffleProb) {
                                    const randId = activePatternIDs[Math.floor(Math.random() * activePatternIDs.length)];
                                    const newPattern = window.ALL_PATTERNS.find(p => p.id === randId);
                                    if (newPattern) {
                                        currentMeasure[i] = newPattern;
                                        const card = displayArea.children[i];
                                        if (card) {
                                            card.innerHTML = `<div class="svg-container">${newPattern.svg}</div>`;
                                            card.classList.remove('changing');
                                            void card.offsetWidth;
                                            card.classList.add('changing');
                                        }
                                    }
                                }
                            }
                        }, Math.max(0, visualDelay + beatDuration * 800)); 
                    }
                }
            }
            if (isPlaying) timerID = requestAnimationFrame(scheduler);
        }

        playBtn.addEventListener('click', (e) => {
            e.preventDefault(); 
            if (isPlaying) {
                isPlaying = false;
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                document.querySelectorAll('.beat-card').forEach(c => c.classList.remove('active'));
            } else {
                initAudio();
                isPlaying = true;
                playBtn.classList.add('playing');
                playBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                currentBeatIndex = 0;
                nextBeatTime = audioCtx.currentTime + 0.1;
                scheduler();
            }
        });

        document.getElementById('kickBtn').addEventListener('click', (e) => {
            kickEnabled = !kickEnabled;
            e.currentTarget.classList.toggle('active');
        });
        document.getElementById('timeSigSelect').addEventListener('change', () => { updateTimeSignature(); generateRhythm(); });
        document.getElementById('bpmSlider').addEventListener('input', (e) => { bpm = parseInt(e.target.value); document.getElementById('bpmDisplay').innerText = bpm; });
        document.getElementById('kickVolSlider').addEventListener('input', (e) => { kickVolume = parseInt(e.target.value) / 100; });
        document.getElementById('clapVolSlider').addEventListener('input', (e) => { clapVolume = parseInt(e.target.value) / 100; });
        document.getElementById('shuffleSlider').addEventListener('input', (e) => { shuffleProb = parseInt(e.target.value); document.getElementById('shuffleDisplay').innerText = shuffleProb + "%"; });

    </script>
</body>
</html>
